---
layout: base.njk
---

<article class="container mx-auto px-4 py-8">
  <header class="mb-8">
    {% if image %}
      <div class="mb-8 -mx-4 sm:-mx-6 md:-mx-8 lg:-mx-12">
        {% image image, title, "eager", "w-full h-[300px] md:h-[400px] object-cover rounded-lg" %}
      </div>
    {% endif %}
    <h1 class="text-4xl font-bold mb-4">{{ title }}</h1>
    <time datetime="{{ page.date | dateIso }}" class="text-gray-600">
      {{ page.date | dateReadable }}
    </time>
  </header>

  <div class="prose prose-lg max-w-none">
    <style>
      .prose img {
        @apply mx-auto rounded-lg shadow-lg my-8;
        max-width: 100%;
        height: auto;
      }
      .prose img + em {
        @apply block text-center text-gray-600 -mt-6 mb-8;
      }
    </style>
    {{ content | safe }}
  </div>

  {% if tags %}
      <div class="tags mt-4 space-x-2">
      tags: 
        {%- for tag in tags -%}
          {%- if tag not in ["all", "nav", "post", "posts"] -%}
            <a 
              href="/tags/{{ tag }}/" 
              class="tag inline-block bg-gray-200 rounded-full px-3 py-1 text-sm font-semibold text-gray-700 hover:bg-gray-300 transition-colors"
              aria-label="View posts tagged {{ tag }}"
            >{{ tag }}</a>
          {%- endif -%}
        {%- endfor -%}
      </div>
    {% endif %}

  <nav class="mt-12 border-t pt-6" aria-label="Post navigation">
    <div class="flex justify-between">
      {%- set previousPost = collections.posts | getPreviousCollectionItem %}
      {%- set nextPost = collections.posts | getNextCollectionItem %}

      {% if previousPost %}
        <a 
          href="{{ previousPost.url }}" 
          class="text-blue-600 hover:text-blue-800 transition-colors flex items-center gap-2" 
          rel="prev"
          aria-label="Previous post: {{ previousPost.data.title }}"
        >
          <span aria-hidden="true">←</span>
          <span>{{ previousPost.data.title }}</span>
        </a>
      {% else %}
        <span></span>
      {% endif %}
 
      {% if nextPost %}
        <a 
          href="{{ nextPost.url }}" 
          class="text-blue-600 hover:text-blue-800 transition-colors flex items-center gap-2" 
          rel="next"
          aria-label="Next post: {{ nextPost.data.title }}"
        >
          <span>{{ nextPost.data.title }}</span>
          <span aria-hidden="true">→</span>
        </a>
      {% else %}
        <span></span>
      {% endif %}
    </div>
  </nav>

  <div class="social-share" aria-label="Share this post">
    <button 
      class="share-button"
      onclick="handleShare('twitter')" 
      aria-label="Share on Twitter"
    >
      Twitter
    </button>
    <button 
      class="share-button"
      onclick="handleShare('facebook')" 
      aria-label="Share on Facebook"
    >
      Facebook
    </button>
    <button 
      class="share-button"
      onclick="handleShare('linkedin')" 
      aria-label="Share on LinkedIn"
    >
      LinkedIn
    </button>
  </div>
</article>

<section class="comments" aria-labelledby="comments-title">
  <h2 id="comments-title">Comments</h2>
  
  <div id="existing-comments">
    {% if comments[page.fileSlug] %}
      {% for comment in comments[page.fileSlug] %}
        <div class="comment">
          <p class="comment-meta">
            <strong>{{ comment.name }}</strong>
            <time 
              datetime="{{ comment.timestamp }}"
              class="comment-time"
              data-timestamp="{{ comment.timestamp }}"
            ></time>
          </p>
          <p class="comment-content">{{ comment.comment }}</p>
        </div>
      {% endfor %}
    {% else %}
      <p>No comments yet. Be the first to comment!</p>
    {% endif %}
  </div>

  <form id="comment-form" class="comment-form" aria-labelledby="comment-form-title">
    <h3 id="comment-form-title">Add a Comment</h3>
    
    {# Honeypot field #}
    <div class="hidden" aria-hidden="true">
      <label for="website">Website</label>
      <input type="text" id="website" name="website" autocomplete="off" tabindex="-1">
    </div>

    <div class="form-group">
      <label for="name">Name *</label>
      <input 
        type="text" 
        id="name" 
        name="name" 
        required 
        maxlength="50"
        aria-required="true">
    </div>

    <div class="form-group">
      <label for="comment">Comment *</label>
      <textarea 
        id="comment" 
        name="comment" 
        required 
        maxlength="1000"
        rows="4"
        aria-required="true"></textarea>
    </div>

    <input type="hidden" name="postSlug" value="{{ page.fileSlug }}">
    
    <button 
      type="submit"
      class="submit-button"
      aria-label="Submit comment">
      Submit Comment
    </button>

    <div id="form-status" role="status" aria-live="polite"></div>
  </form>
</section>

<script>
  const form = document.getElementById('comment-form');
  const status = document.getElementById('form-status');
  const comments = document.getElementById('existing-comments');

  // Format timestamps relative to now
  function formatRelativeTime(timestamp) {
    const date = new Date(timestamp);
    const now = new Date();
    const diffInSeconds = Math.floor((now - date) / 1000);
    
    if (diffInSeconds < 60) {
      return 'just now';
    } else if (diffInSeconds < 3600) {
      const minutes = Math.floor(diffInSeconds / 60);
      return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
    } else if (diffInSeconds < 86400) {
      const hours = Math.floor(diffInSeconds / 3600);
      return `${hours} hour${hours > 1 ? 's' : ''} ago`;
    } else if (diffInSeconds < 604800) {
      const days = Math.floor(diffInSeconds / 86400);
      return `${days} day${days > 1 ? 's' : ''} ago`;
    } else {
      return date.toLocaleDateString(undefined, { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }
  }

  // Update all timestamps on the page
  function updateTimestamps() {
    document.querySelectorAll('.comment-time').forEach(timeElement => {
      const timestamp = timeElement.dataset.timestamp;
      timeElement.textContent = formatRelativeTime(timestamp);
    });
  }

  // Update timestamps immediately and every minute
  updateTimestamps();
  setInterval(updateTimestamps, 60000);

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(form);
    const data = {
      name: formData.get('name'),
      comment: formData.get('comment'),
      postSlug: formData.get('postSlug'),
      honeypot: formData.get('website')
    };

    try {
      status.textContent = 'Submitting...';
      
      // Use relative URL to work in all environments
      const response = await fetch('/.netlify/functions/submit-comment', {
        method: 'POST',
        body: JSON.stringify(data),
        headers: {
          'Content-Type': 'application/json'
        }
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const result = await response.json();

      if (result.success) {
        status.textContent = 'Comment submitted! It will appear on the site after the next build (usually within a minute).';
        form.reset();
      } else {
        status.textContent = result.error || 'Error submitting comment. Please try again.';
      }
    } catch (error) {
      console.error('Error:', error);
      status.textContent = 'Error submitting comment. Please try again.';
    }
  });
</script>
